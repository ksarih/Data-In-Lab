---
title: "DATA IN LAB"
output: html_document
date: "2025-11-26"
---

# Introduction

```{r ,  echo = FALSE}
library(dplyr)
library(ggplot2)
```


# Netoyage des données

```{r données}



df_VITAL_STATUS <- read.csv("Data/VITAL_STATUS.csv")
df_RANDOMIZATION <- read.csv("Data/RANDOMIZATION.csv")
df_SOFA <- read.csv("Data/SOFA.csv")

### Id les individus mort avant J28
Indiv_mort <- df_VITAL_STATUS %>%
  filter(VITAL_STATUS_D28 == 0) %>%
  select (SUBJID, SURNAME, NAME)
# 279 mort avant J28




### Création d'un df final 
# filtrage des modalités
df_RANDOMIZATION <- df_RANDOMIZATION %>%
  select(SUBJID,INCL_SEPSIS_YN,AGE_CLASS,INCL_AKIN,ARM_NUM)

df_VITAL_STATUS <- df_VITAL_STATUS %>%
  select(SUBJID,VITAL_STATUS_D28)

df_SOFA <- df_SOFA %>%
  select(SUBJID,SOFA_hepatic_D7,SOFA_cardiovasc_D7, SOFA_respiratory_D7, SOFA_neurologic_D7, SOFA_renal_D7, SOFA_haematologic_D7)


### Fusion finale
data <- df_RANDOMIZATION %>%
  left_join(df_VITAL_STATUS, by = "SUBJID") %>%
  left_join(df_SOFA, by = "SUBJID")




#calcul de l'estimateur / patient : Sofa < 3: (1) /Non (0)
#et calcul de l'estimateur / patient : Favorable(1) /Non (0)
#initialisation des nouvelles variables :
data$Sofa_ok<-rep(NA, 400)
data$Favorable<-rep(NA, 400)

for (i in 1:400) {
  data[i,"Sofa_ok"]<-if (max(data[i,c("SOFA_hepatic_D7","SOFA_cardiovasc_D7", "SOFA_respiratory_D7", "SOFA_neurologic_D7", "SOFA_renal_D7", "SOFA_haematologic_D7")]) < 3) 1 else 0 #Sofa_ok
  data[i,'Favorable']<-if(data[i,"VITAL_STATUS_D28"]== 1 & data[i,"Sofa_ok"]==1) 1 else 0 #Favorable 1/0
}



data <- data %>%
  select (SUBJID, INCL_SEPSIS_YN, AGE_CLASS, INCL_AKIN, VITAL_STATUS_D28, Sofa_ok, Favorable, ARM_NUM)

head(data)
```

# Exploration 

```{r}
###### Exploration 
sum(data$Favorable) #67 Favorable
sum(data$Sofa_ok) # 193 SOfa OK
sum(data$VITAL_STATUS_D28) #121 Survivants 28J
sum(data$ARM_NUM) #199 traité au SB

sum(data$AGE_CLASS == 1 & data$Favorable == 1  & data$ARM_NUM == 1)
sum(data$AGE_CLASS == 0 & data$Favorable == 1  & data$ARM_NUM == 1)
sum(data$AGE_CLASS == 1 & data$VITAL_STATUS_D28 == 1)
sum(data$AGE_CLASS == 0)
```


```{r}
a <- sum(data$Favorable == 1 & data$ARM_NUM == 1) #44
c <- sum(data$Favorable == 1 & data$ARM_NUM == 0) #23
b <- sum(data$Favorable == 0 & data$ARM_NUM == 1) #155
d <- sum(data$Favorable == 0 & data$ARM_NUM == 0) #178

Tab_contingence <- matrix(
  c(a, b, c, d),
  nrow = 2,
  byrow = TRUE,
  dimnames = list(
    ARM_NUM   = c("1_traitement_SB", "0_sans_SB"),
    Favorable = c("1_oui", "0_non")
  )
)

Tab_contingence
```



# Test du CHI 2

```{r}
res_chi2 <- chisq.test(Tab_contingence, correct = FALSE)
res_chi2

res_chi2$expected #effectif attendue 
res_chi2$p.value

```
On obtient une p_value = 0.00428 < 0.05 donc on rejette HO donc une issue favorable dépend du traitement reçu 



## Test du CHI2 pour chaque sous groupe 

### AGE 
```{r}
# Patient de < 65 ans
tab_age0 <- table(
  ARM_NUM   = data$ARM_NUM[data$AGE_CLASS == 0],
  Favorable = data$Favorable[data$AGE_CLASS == 0]
)
test_age0 <- chisq.test(tab_age0, correct = FALSE)
tab_age0
test_age0



# Patient de > 65 ans
tab_age1 <- table(
  ARM_NUM   = data$ARM_NUM[data$AGE_CLASS == 1],
  Favorable = data$Favorable[data$AGE_CLASS == 1]
)

test_age1 <- chisq.test(tab_age1, correct = FALSE)
tab_age1
test_age1
```


Donc on a une p-values 0.002505 < 0.05 donc le traitement est éfficace sur les permsonnes de moins de 65 ans.
Chez les patients de plus de 65 ans, on ne met pas en évidence d’association statistiquement significative entre le traitement par bicarbonate et l’issue favorable (chi2(1) = 1,85 ; p = 0,17 > 0.05) 

### AKIN

```{r}
# INCL_AKIN == 0
tab_akin0 <- table(
  ARM_NUM   = data$ARM_NUM[data$INCL_AKIN == 0],
  Favorable = data$Favorable[data$INCL_AKIN == 0]
)
test_akin0 <- chisq.test(tab_akin0, correct = FALSE)
tab_akin0
test_akin0

# INCL_AKIN == 1
tab_akin1 <- table(
  ARM_NUM   = data$ARM_NUM[data$INCL_AKIN == 1],
  Favorable = data$Favorable[data$INCL_AKIN == 1]
)
test_akin1 <- chisq.test(tab_akin1, correct = FALSE)
tab_akin1
test_akin1
#OR
OR_AKIN1 <- (27*84)/(12*66)
OR_AKIN1
```

Pour les patients ayant un score AKIN de 0 ou 1 le test n'est pas siginificatif les résultats peuvent etre du au hasard.

Chez les patients avec AKIN = 1, il existe une association statistiquement significative entre le traitement par bicarbonate et l’issue favorable (chi2(1) = 7,88 ; p = 0,005 < 0.05). La proportion d’issues favorables est d’environ 29 % sous SB contre 12,5 % sans SB.
les odds d’issue favorable sont ≈ 2,9 fois plus élevées sous SB que sans SB chez les patients AKIN = 1.



### sepsis

```{r}
# INCL_SEPSIS_YN == 0 (sans sepsis)
tab_sepsis0 <- table(
  ARM_NUM   = data$ARM_NUM[data$INCL_SEPSIS_YN == 0],
  Favorable = data$Favorable[data$INCL_SEPSIS_YN == 0]
)
tab_sepsis0
test_sepsis0 <-chisq.test(tab_sepsis0, correct = FALSE)
test_sepsis0

# INCL_SEPSIS_YN == 1 (avec sepsis)
tab_sepsis1 <- table(
  ARM_NUM   = data$ARM_NUM[data$INCL_SEPSIS_YN == 1],
  Favorable = data$Favorable[data$INCL_SEPSIS_YN == 1]
)
test_sepsis1 <- chisq.test(tab_sepsis1, correct = FALSE)
tab_sepsis1
test_sepsis1
```
Chez les patients sans sepsis, on met en évidence une association significative entre traitement par bicarbonate et issue favorable : environ 26 % d’issues favorables sous SB contre 12 % sans SB (chi2(1) = 5,50 ; p = 0,019).

Chez les patients avec sepsis, la proportion d’issues favorables est plus élevée sous SB ( 19 %) que sans SB (11 %),meme si le test n'est optimal la p- values reste siginificative (chi2(1) = 3,08 ; p = 0,079).




## Tableau récapitulatif




```{r}
# On recrée un tableau global propre au cas où (avec modalités 0 / 1)
Tab_contingence <- table(
  ARM_NUM   = data$ARM_NUM,
  Favorable = data$Favorable
)

# Fonction pour calculer OR et IC95% à partir d'un tableau 2x2
# tab : table(ARM_NUM, Favorable) avec ARM_NUM = 0/1, Favorable = 0/1

compute_OR_IC <- function(tab) {
  
  # Vérification légère : on s'assure qu'on a bien les modalités "0" et "1"
  if (!all(c("0", "1") %in% rownames(tab)) || !all(c("0", "1") %in% colnames(tab))) {
    stop("Le tableau doit avoir des lignes et colonnes nommées '0' et '1'.")
  }
  
  a <- tab["1", "1"]  # Traitement, favorable
  b <- tab["1", "0"]  # Traitement, non favorable
  c <- tab["0", "1"]  # Contrôle, favorable
  d <- tab["0", "0"]  # Contrôle, non favorable
  
  # Correction si une des cases vaut 0 (pour éviter divisions par 0)
  if (any(c(a, b, c, d) == 0)) {
    a <- a + 0.5
    b <- b + 0.5
    c <- c + 0.5
    d <- d + 0.5
  }
  
  OR       <- (a * d) / (b * c)
  log_OR   <- log(OR)
  SE_logOR <- sqrt(1 / a + 1 / b + 1 / c + 1 / d)
  
  IC_inf <- exp(log_OR - 1.96 * SE_logOR)
  IC_sup <- exp(log_OR + 1.96 * SE_logOR)
  
  c(OR = OR, IC_inf = IC_inf, IC_sup = IC_sup)
}

# OR + IC pour chaque tableau déjà créé plus haut

or_all     <- compute_OR_IC(Tab_contingence)
or_age0    <- compute_OR_IC(tab_age0)
or_age1    <- compute_OR_IC(tab_age1)
or_akin0   <- compute_OR_IC(tab_akin0)
or_akin1   <- compute_OR_IC(tab_akin1)
or_sepsis0 <- compute_OR_IC(tab_sepsis0)
or_sepsis1 <- compute_OR_IC(tab_sepsis1)

# Tableau récapitulatif

results_chi2 <- data.frame(
  Variable = c(
    "Global",
    "AGE_CLASS", "AGE_CLASS",
    "INCL_AKIN", "INCL_AKIN",
    "INCL_SEPSIS_YN", "INCL_SEPSIS_YN"
  ),
  Modalite = c(
    "Tous",
    "<65", "≥65",
    "0", "1",
    "0", "1"
  ),
  Chi2 = c(
    as.numeric(res_chi2$statistic),
    as.numeric(test_age0$statistic),
    as.numeric(test_age1$statistic),
    as.numeric(test_akin0$statistic),
    as.numeric(test_akin1$statistic),
    as.numeric(test_sepsis0$statistic),
    as.numeric(test_sepsis1$statistic)
  ),
  p_value = c(
    res_chi2$p.value,
    test_age0$p.value,
    test_age1$p.value,
    test_akin0$p.value,
    test_akin1$p.value,
    test_sepsis0$p.value,
    test_sepsis1$p.value
  ),
  OR = c(
    or_all["OR"],
    or_age0["OR"],
    or_age1["OR"],
    or_akin0["OR"],
    or_akin1["OR"],
    or_sepsis0["OR"],
    or_sepsis1["OR"]
  ),
  IC_inf = c(
    or_all["IC_inf"],
    or_age0["IC_inf"],
    or_age1["IC_inf"],
    or_akin0["IC_inf"],
    or_akin1["IC_inf"],
    or_sepsis0["IC_inf"],
    or_sepsis1["IC_inf"]
  ),
  IC_sup = c(
    or_all["IC_sup"],
    or_age0["IC_sup"],
    or_age1["IC_sup"],
    or_akin0["IC_sup"],
    or_akin1["IC_sup"],
    or_sepsis0["IC_sup"],
    or_sepsis1["IC_sup"]
  )
)

results_chi2

```
L’analyse globale montre une association statistiquement significative entre le traitement par bicarbonate (SB) et l’issue favorable. Les patients traités présentent environ 2,2 fois plus de chances d’obtenir une évolution favorable que ceux du groupe contrôle (OR = 2,20 ; IC95% : 1,27–3,80). L’intervalle de confiance ne contenant pas 1, cet effet apparaît robuste. Ces résultats suggèrent un bénéfice global du traitement dans la population étudiée.

l’étude par sous-groupe révèle une forte hétérogénéité selon l’âge. Le traitement SB est particulièrement efficace chez les patients de moins de 65 ans, avec un odds ratio d’environ 4,4 (IC95% : 1,58–12,25). À l’inverse, aucun effet significatif n’est observé chez les patients de 65 ans et plus (OR = 1,60 ; p = 0,17). Cela suggère que le bénéfice du SB est principalement porté par les patients plus jeunes.

Une hétérogénéité comparable apparaît selon le degré d’atteinte rénale. Chez les patients avec AKIN = 0, aucun effet significatif n’est détecté. En revanche, chez ceux présentant une atteinte rénale modérée (AKIN = 1), le traitement est associé à un gain net (OR = 2,86 ; IC95% : 1,35–6,08). Le SB semble donc particulièrement bénéfique lorsque l’atteinte rénale est déjà présente.

Le traitement SB améliore significativement l’issue favorable chez les patients sans sepsis (OR = 2,63 ; p = 0,019). Chez les patients avec sepsis, une tendance en faveur du traitement est observée (OR = 1,92), mais celle-ci n’atteint pas le seuil de significativité statistique (p = 0,079). Le bénéfice du SB semble donc plus marqué chez les patients non septicémiques.


En résumé, le traitement au bicarbonate (SB) montre un effet favorable global, mais celui-ci varie selon les caractéristiques des patients. Les sous-groupes qui tirent le plus grand bénéfice sont les patients jeunes (<65 ans), avec AKIN = 1, et sans sepsis. Chez les patients plus âgés ou septicémiques, l’effet apparaît moins net ou non significatif.






# Regression logistique 


## Régression logistique simple : effet du traitement SB sur l’issue favorable

```{r logit_simple}
# Modèle logistique : Favorable ~ ARM_NUM
# (ARM_NUM = 0 : contrôle, 1 : traitement SB)

mod_simple <- glm(
  Favorable ~ ARM_NUM,
  data   = data,
  family = binomial(link = "logit")
)

# Résumé du modèle (coefficients sur l'échelle log-odds)
summary(mod_simple)

# Odds ratios (exp(beta))
OR_simple <- exp(coef(mod_simple))
OR_simple

# Intervalles de confiance 95% des OR
IC_OR_simple <- exp(confint(mod_simple))   # IC pour les coefficients, puis exponentiés
IC_OR_simple

# Tableau récapitulatif propre
res_mod_simple <- data.frame(
  Coef    = names(OR_simple),
  OR      = OR_simple,
  IC_inf  = IC_OR_simple[, 1],
  IC_sup  = IC_OR_simple[, 2]
)

res_mod_simple



````


## Régression logistique ajustée : effet du traitement SB ajusté sur l’âge, AKIN et sepsis

```{r logit_ajuste}

# Modèle logistique ajusté
mod_ajuste <- glm(
  Favorable ~ ARM_NUM + AGE_CLASS + INCL_AKIN + INCL_SEPSIS_YN,
  data   = data,
  family = binomial(link = "logit")
)

summary(mod_ajuste)

# EXTRACTION : OR + IC95% + p-values
OR_ajuste      <- exp(coef(mod_ajuste))
IC_OR_ajuste   <- exp(confint(mod_ajuste)) 
p_values       <- summary(mod_ajuste)$coefficients[, 4]   # colonne des p-values
coefs        <- summary(mod_ajuste)$coefficients

# Data frame final propre
res_mod_ajuste <- data.frame(
  Coef      = coefs[, "Estimate"],
  OR      = OR_ajuste,
  IC_inf  = IC_OR_ajuste[, 1],
  IC_sup  = IC_OR_ajuste[, 2],
  p_value = p_values
)

res_mod_ajuste
````

Après ajustement sur l’âge, le score AKIN et la présence de sepsis, le traitement par bicarbonate reste significativement associé à une issue favorable. Les patients traités ont environ 2,3 fois plus de chances d’obtenir un résultat favorable que ceux du groube sns SB (p = 0.003).

L’âge et le score AKIN sont également associés à l’issue : les patients ≥65 ans et ceux avec un score AKIN >= 2 présentent chacun une probabilité plus élevée d’issu favorable. En revanche, le statut de sepsis n’a pas montré d’effet significatif dans ce modèle.

Globalement, le traitement conserve un effet positif même après prise en compte des autres caractéristiques cliniques.



## Régression logistique avec interactions : ARM_NUM croisé avec AGE_CLASS, INCL_AKIN et INCL_SEPSIS_YN

```{r}

# Modèle avec interactions : ARM_NUM croisé avec les 3 caractéristiques
mod_inter <- glm(
  Favorable ~ ARM_NUM * AGE_CLASS +
              ARM_NUM * INCL_AKIN +
              ARM_NUM * INCL_SEPSIS_YN,
  data   = data,
  family = binomial(link = "logit")
)

summary(mod_inter)

# Extraction OR, IC95%, p-values
coef_inter   <- coef(mod_inter)
OR_inter     <- exp(coef_inter)
IC_inter     <- exp(confint(mod_inter))
p_values_int <- summary(mod_inter)$coefficients[, 4]

# Tableau récapitulatif
res_mod_inter <- data.frame(
  Coef    = names(OR_inter),
  OR      = OR_inter,
  IC_inf  = IC_inter[, 1],
  IC_sup  = IC_inter[, 2],
  p_value = p_values_int
)

res_mod_inter
````

### Régression logistique avec interaction ARM_NUM × AGE_CLASS

```{r logit_inter_age}
mod_inter_age <- glm(
  Favorable ~ ARM_NUM * AGE_CLASS,
  data   = data,
  family = binomial(link = "logit")
)

summary(mod_inter_age)

# OR + IC95% + p-values
coef_age   <- coef(mod_inter_age)
OR_age     <- exp(coef_age)
IC_age     <- exp(confint(mod_inter_age))
p_age      <- summary(mod_inter_age)$coefficients[, 4]

res_mod_inter_age <- data.frame(
  Coef    = names(OR_age),
  OR      = OR_age,
  IC_inf  = IC_age[, 1],
  IC_sup  = IC_age[, 2],
  p_value = p_age
)

res_mod_inter_age
````


En utilisant un seuil de tolérance élargi (alpha = 10%), l’interaction ARM_NUM × AGE_CLASS devient proche du seuil (p=0.1). Cela suggère une tendance indiquant que l’effet du traitement pourrait être plus marqué chez les <65 ans que chez les >65 ans.

En termes de coefficients, le traitement présente un effet très important chez les <65 ans (OR = 4.4), alors que cet effet est plus modéré chez les >65 ans (OR = 1.6). L’âge et le traitement restent tous deux significatifs de manière indépendante, mais l’interaction ne l’est pas clairement.



## Régression logistique avec interaction ARM_NUM × INCL_AKIN

```{r}
mod_inter_akin <- glm(
  Favorable ~ ARM_NUM * INCL_AKIN,
  data   = data,
  family = binomial(link = "logit")
)

summary(mod_inter_akin)

# OR + IC95% + p-values
coef_akin   <- coef(mod_inter_akin)
OR_akin     <- exp(coef_akin)
IC_akin     <- exp(confint(mod_inter_akin))
p_akin      <- summary(mod_inter_akin)$coefficients[, 4]

res_mod_inter_akin <- data.frame(
  Coef    = names(OR_akin),
  OR      = OR_akin,
  IC_inf  = IC_akin[, 1],
  IC_sup  = IC_akin[, 2],
  p_value = p_akin
)

res_mod_inter_akin
`````



---

## Régression logistique avec interaction ARM_NUM × INCL_SEPSIS_YN

```{r logit_inter_sepsis}
mod_inter_sepsis <- glm(
  Favorable ~ ARM_NUM * INCL_SEPSIS_YN,
  data   = data,
  family = binomial(link = "logit")
)

summary(mod_inter_sepsis)

# OR + IC95% + p-values
coef_sepsis   <- coef(mod_inter_sepsis)
OR_sepsis     <- exp(coef_sepsis)
IC_sepsis     <- exp(confint(mod_inter_sepsis))
p_sepsis      <- summary(mod_inter_sepsis)$coefficients[, 4]

res_mod_inter_sepsis <- data.frame(
  Coef    = names(OR_sepsis),
  OR      = OR_sepsis,
  IC_inf  = IC_sepsis[, 1],
  IC_sup  = IC_sepsis[, 2],
  p_value = p_sepsis
)

res_mod_inter_sepsis

````


